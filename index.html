<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Веб-сканер штрих-кодов (офлайн)</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <style>
    body { font-family: Arial, sans-serif; display:flex; gap:20px; padding:20px; }
    #left { max-width:640px; }
    video { width:100%; max-width:640px; border:1px solid #ccc; background:#000; }
    canvas { display:none; }
    #output { padding:10px; border:1px solid #ddd; min-height:40px; width:320px; }
    button { margin-right:8px; padding:8px 12px; }
    .hint { color:#666; font-size:0.9rem; margin-top:8px; }
  </style>
</head>
<body>
  <div id="left">
    <h2>Сканер штрих/QR_QR — офлайн</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div class="hint">Поддерживаемые браузеры: Chromium/Chrome/Edge (лучше всего). Если камера не стартует — проверь, что открыт через <code>localhost</code> или по HTTPS.</div>
    <div style="margin-top:8px;">
      <button id="startBtn">Запустить камеру</button>
      <button id="stopBtn" disabled>Остановить</button>
    </div>
  </div>

  <div id="right">
    <h3>Результат</h3>
    <div id="output">— нет данных —</div>
    <div class="hint" style="margin-top:10px;">
      Запасной вариант: jsQR (если BarcodeDetector не поддерживается). Для этого скачай <code>jsQR</code> и подключи локально (см. инструкцию ниже).
    </div>
  </div>

<script>
(async function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const output = document.getElementById('output');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');

  let stream = null;
  let rafId = null;
  let detector = null;
  let useBarcodeDetector = false;

  // Проверяем поддержку BarcodeDetector
  if ('BarcodeDetector' in window) {
    try {
      const supported = await BarcodeDetector.getSupportedFormats();
      // Поддерживаемые форматы сюда попадут, например: ["qr_code","ean_13",...]
      detector = new BarcodeDetector({formats: supported});
      useBarcodeDetector = true;
      console.log('Используем BarcodeDetector. Форматы:', supported);
    } catch (e) {
      console.warn('BarcodeDetector не доступен:', e);
      useBarcodeDetector = false;
    }
  } else {
    console.log('BarcodeDetector не поддерживается в этом браузере.');
  }

  // Функция обработки кадра
  async function processFrame() {
    if (!video.videoWidth) {
      rafId = requestAnimationFrame(processFrame);
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    try {
      if (useBarcodeDetector && detector) {
        // Используем нативный API
        const barcodes = await detector.detect(canvas);
        if (barcodes && barcodes.length) {
          // Показать все найденные
          output.innerHTML = barcodes.map(b => {
            // b.rawValue — данные; b.format — формат
            return `<div><strong>${b.format}</strong>: ${escapeHtml(b.rawValue)}</div>`;
          }).join('');
        } else {
          // нет результата
          output.textContent = '— не найдено —';
        }
      } else {
        // Запасной вариант: jsQR (нужен глобальный jsQR)
        if (typeof jsQR === 'function') {
          const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const qr = jsQR(imageData.data, imageData.width, imageData.height);
          if (qr) {
            output.innerHTML = `<div><strong>JSQR</strong>: ${escapeHtml(qr.data)}</div>`;
            // можно добавить отрисовку рамки: qr.location...
            drawLine(qr.location.topLeftCorner, qr.location.topRightCorner);
            drawLine(qr.location.topRightCorner, qr.location.bottomRightCorner);
            drawLine(qr.location.bottomRightCorner, qr.location.bottomLeftCorner);
            drawLine(qr.location.bottomLeftCorner, qr.location.topLeftCorner);
          } else {
            output.textContent = '— не найдено —';
          }
        } else {
          output.textContent = 'BarcodeDetector не поддерживается и jsQR не подключён.';
        }
      }
    } catch (err) {
      console.error(err);
      output.textContent = 'Ошибка: ' + err.message;
    }

    rafId = requestAnimationFrame(processFrame);
  }

  function drawLine(a, b) {
    ctx.strokeStyle = '#FF3B3B';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
  }

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      await video.play();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      rafId = requestAnimationFrame(processFrame);
      output.textContent = 'Камера запущена, ищем штрих/QR...';
    } catch (e) {
      console.error('Ошибка доступа к камере:', e);
      output.textContent = 'Ошибка доступа к камере: ' + (e.message || e.name);
    }
  }

  function stopCamera() {
    if (rafId) cancelAnimationFrame(rafId);
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    output.textContent = 'Камера остановлена.';
  }

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);

  // Если хочешь — можно автозапускать:
  // startCamera();

})();

if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js').catch(function(err) {
      console.warn('Service Worker не зарегистрирован:', err);
    });
  });
}
</script>

<!--
Запасной вариант (jsQR):
1) Скачай jsQR (https://github.com/cozmo/jsQR) — бери скомпилированный файл jsQR.js (или jsQR.min.js).
2) Положи его в ту же папку, что и index.html.
3) Раскомментируй следующий тег, чтобы подключить локальную библиотеку:

<script src="jsqr.min.js"></script>

-->
</body>
</html>
