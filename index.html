<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Настройки</title>
  <meta name="theme-color" content="#4CAF50" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 520px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    .serial-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    .serial-row input[type="text"] {
      margin-bottom: 0;
    }
    .serial-row button {
      width: auto;
      padding: 8px 12px;
      white-space: nowrap;
    }
    .ip-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    .ip-row input[type="text"] {
      margin-bottom: 0;
    }
    .ip-row input[readonly] {
      background: #f3f4f6;
      color: #4b5563;
      cursor: not-allowed;
    }
    input[type="submit"], button {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    button.secondary {
      background-color: #6b7280;
    }
    input[type="submit"]:hover, button:hover {
      background-color: #45a049;
    }
    button.secondary:hover {
      background-color: #5a6270;
    }
    #error-msg {
      color: red;
      margin-bottom: 10px;
    }
    .invalid {
      border-color: #ef4444;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }
    .scanner {
      margin-top: 20px;
      border-top: 1px solid #e5e7eb;
      padding-top: 16px;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.55);
      padding: 20px;
      z-index: 1000;
    }
    .modal.hidden {
      display: none;
    }
    .modal-content {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 8px;
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
    }
    video {
      width: 100%;
      border: 1px solid #ccc;
      background: #000;
      border-radius: 4px;
    }
    canvas { display: none; }
    .hint {
      color: #666;
      font-size: 0.9rem;
      margin-top: 8px;
    }
    #output {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 36px;
      margin-top: 10px;
    }
    @media (max-width: 600px) {
      body {
        padding: 16px;
        max-width: 100%;
      }
      .ip-row,
      .serial-row {
        grid-template-columns: 1fr;
      }
      .serial-row button {
        width: 100%;
      }
      input[type="submit"], button {
        font-size: 16px;
      }
      h2 {
        text-align: center;
      }
    }
  </style>
  <script>
    const IP_PREFIX = '192.168.0.';

    function buildIp() {
      const lastOctet = document.getElementById('ip').value.trim();
      return IP_PREFIX + lastOctet;
    }

    function validateForm() {
      const lastOctet = document.getElementById('ip').value.trim();
      const idProduct = document.getElementById('serial').value.trim();
      const form = document.getElementById('myForm');
      const errorMsg = document.getElementById('error-msg');
      const ipInput = document.getElementById('ip');
      const serialInput = document.getElementById('serial');

      ipInput.classList.remove('invalid');
      serialInput.classList.remove('invalid');

      if (!/^\d{1,3}$/.test(lastOctet)) {
        errorMsg.textContent = "Введите последние 1–3 цифры IP-адреса.";
        ipInput.classList.add('invalid');
        return false;
      }
      const lastOctetValue = Number(lastOctet);
      if (Number.isNaN(lastOctetValue) || lastOctetValue > 255) {
        errorMsg.textContent = "Последний октет IP должен быть в диапазоне 0–255.";
        ipInput.classList.add('invalid');
        return false;
      }
      if (idProduct.length !== 6) {
        errorMsg.textContent = "Номер устройства должен содержать 6 символов.";
        serialInput.classList.add('invalid');
        return false;
      }

      errorMsg.textContent = "";
      form.action = 'http://' + buildIp() + '/set_data';
      return true;
    }
  </script>
</head>
<body>
  <h2>Настройки</h2>
  <div id="error-msg"></div>

  <label for="ip">IP-адрес устройства:</label>
  <div class="ip-row">
    <input type="text" id="ip-prefix" value="192.168.0." readonly>
    <input type="text" id="ip" inputmode="numeric" maxlength="3" placeholder="1–255" autocomplete="off">
  </div>

  <form id="myForm" method="GET" onsubmit="return validateForm()">
    <label for="serial">Серийный номер:</label>
    <div class="serial-row">
      <input type="text" id="serial" name="serial" maxlength="6">
      <button id="scanBtn" type="button">QR‑код</button>
    </div>
    <input type="submit" value="Отправить">
  </form>

  <div class="modal hidden" id="scannerModal">
    <div class="modal-content">
      <div class="scanner" id="scanner">
        <h3>Сканер QR/штрих‑кодов</h3>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <button id="stopBtn" type="button" class="secondary" disabled>Остановить</button>
        <div id="output">— нет данных —</div>
        
      </div>
    </div>
  </div>

<script>
(async function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const output = document.getElementById('output');
  const scanBtn = document.getElementById('scanBtn');
  const stopBtn = document.getElementById('stopBtn');
  const serialInput = document.getElementById('serial');
  const scannerModal = document.getElementById('scannerModal');

  let stream = null;
  let rafId = null;
  let detector = null;
  let useBarcodeDetector = false;
  let captured = false;

  if ('BarcodeDetector' in window) {
    try {
      const supported = await BarcodeDetector.getSupportedFormats();
      detector = new BarcodeDetector({ formats: supported });
      useBarcodeDetector = true;
    } catch (e) {
      useBarcodeDetector = false;
    }
  }

  async function processFrame() {
    if (!video.videoWidth) {
      rafId = requestAnimationFrame(processFrame);
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    try {
      if (useBarcodeDetector && detector) {
        const barcodes = await detector.detect(canvas);
        if (barcodes && barcodes.length) {
          const value = barcodes[0].rawValue || '';
          handleDetected(value, barcodes[0].format);
        } else {
          output.textContent = '— не найдено —';
        }
      } else {
        if (typeof jsQR === 'function') {
          const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const qr = jsQR(imageData.data, imageData.width, imageData.height);
          if (qr) {
            handleDetected(qr.data, 'JSQR');
            drawLine(qr.location.topLeftCorner, qr.location.topRightCorner);
            drawLine(qr.location.topRightCorner, qr.location.bottomRightCorner);
            drawLine(qr.location.bottomRightCorner, qr.location.bottomLeftCorner);
            drawLine(qr.location.bottomLeftCorner, qr.location.topLeftCorner);
          } else {
            output.textContent = '— не найдено —';
          }
        } else {
          output.textContent = 'BarcodeDetector не поддерживается и jsQR не подключён.';
        }
      }
    } catch (err) {
      output.textContent = 'Ошибка: ' + err.message;
    }

    rafId = requestAnimationFrame(processFrame);
  }

  function handleDetected(value, label) {
    if (!value) {
      output.textContent = '— не найдено —';
      return;
    }
    output.textContent = label + ': ' + value;
    if (!captured) {
      captured = true;
      serialInput.value = value;
      stopCamera();
    }
  }

  function drawLine(a, b) {
    ctx.strokeStyle = '#FF3B3B';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();
  }

  async function startCamera() {
    try {
      captured = false;
      scannerModal.classList.remove('hidden');
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      await video.play();
      scanBtn.disabled = true;
      stopBtn.disabled = false;
      rafId = requestAnimationFrame(processFrame);
      output.textContent = 'Камера запущена, ищем штрих/QR...';
    } catch (e) {
      output.textContent = 'Ошибка доступа к камере: ' + (e.message || e.name);
    }
  }

  function stopCamera() {
    if (rafId) cancelAnimationFrame(rafId);
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    scanBtn.disabled = false;
    stopBtn.disabled = true;
    scannerModal.classList.add('hidden');
    if (!captured) {
      output.textContent = 'Камера остановлена.';
    }
  }

  scanBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);
})();

(() => {
  const ipInput = document.getElementById('ip');
  const serialInput = document.getElementById('serial');
  const submitBtn = document.querySelector('input[type="submit"]');

  function updateSubmitState() {
    submitBtn.disabled = false;
  }

  ipInput.addEventListener('input', () => {
    ipInput.value = ipInput.value.replace(/[^\d]/g, '').slice(0, 3);
    document.getElementById('error-msg').textContent = '';
    ipInput.classList.remove('invalid');
    updateSubmitState();
  });
  serialInput.addEventListener('input', () => {
    document.getElementById('error-msg').textContent = '';
    serialInput.classList.remove('invalid');
    updateSubmitState();
  });
  updateSubmitState();
})();

if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js').catch(function(err) {
      console.warn('Service Worker не зарегистрирован:', err);
    });
  });
}
</script>

</body>
</html>
